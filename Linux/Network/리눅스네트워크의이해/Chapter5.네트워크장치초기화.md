#### 다루는 내용
- 코어 네트워크 초기화 루틴
- NIC 초기화 루틴
- NIC가 인터럽트를 사용하는 방법과 IRQ 핸들러를 할당/해제하는 방법
  - IRQ를 드라이버들이 공유하는 방법
- 장치 초기화/설정 시 사용자 공간과 커널 공간 간의 상호작용
  - 커널이 사용자 공간에 있는 디바이스 드라이버와 설정을 적용하기 위해 사용자 공간 헬퍼를 수행하는 방법
  - 핫 플러그 기능
- 커널과의 상호작용과 설정에서 가상 장치와 실제 장치와의 차이점


### 시스템 초기화 개요
- 주의: 네트워킹과 관련된 초기화만 다룰것임

#### 이 책에서 다루는 시스템 초기화의 주 과정
- Boot-time 옵션
  - parse_args 호출을 통해 LILO나 GRUB이 전달한 커널 설졍 변수 처리
- 인터럽트와 타이머
  - IRQ에 대한 핸들러를 디바이스 드라이버가 어떻게 등록
- 초기화 루틴
  - 커널 서브시스템과 빌트인 디바이스 드라이버의 최기화

#### run_init_process를 통한 최초 프로세스 생성
- run_init_process에서 모든 프로세스의 부모가 될 첫 프로세스 생성
  - PID 1
  - 시스템 종료시까지 멈추지 않음
- 일반적으로는 SysVinit 패키지에 포함된 init 으로 수행 
  - 사용자가 부팅 옵션으로 init= 을 줌으로서 원하는 프로세스 지정 가능


### 장치 등록과 초기화
- 네트워크 장치가 사용 가능하려면 커널에 의해 인식되고 적절한 드라이버와 연결되어야 함
- 드라이버는 장치를 필요로 하는 커널 컴포넌트와 연결하기 위한 정보를 내부 데이터 스트럭쳐에 저장
- 이 과정은 코어 커널과 디바이스 드라이버에 의해 나누어 진행

#### 하드웨어 초기화
- 디바이스 드라이버가 포괄적 버스계층 (PCI, USB 등) 의 도움을 받아 수행됨
- 각 장치의 IRQ와 I/O 주소를 설정하여 커널에서 사용할 수 있게 함
#### 소프트웨어 초기화
- 장치가 사용되기 전 어떤 네트워크 프로토콜이 활성화되었는지에 따라 추가 정보 필요
  - ex) IP주소
- 다른 장에서 상세히 다룸
#### 기능 초기화
- 장치 부트 초기 단계에 신경을 써줘야 하는 옵션 설정
  - ex) 전송량 조절 시스템의 큐


### NIC(Network Interface Card = 이더넷 랜 카드) 초기화의 기본 목적
- 네트워크 장치는 커널 내 net_device_data 스트럭쳐의 인스턴스로 표현
- 이 과정에서 드라이버가 장치/커널 간 통신에 필요한 리소스 할당

#### IRQ 라인
- NIC는 IRQ를 할당받고 필요한경우 커널에 인터럽트를 검
  - 단, 가상 장치의 경우 IRQ를 지정받을 수 없음
    - ex) 루프백 장치
- /proc/interrupts 파일에서 현재 IRQ 할당 현환 확인 가능
#### I/O 포트와 메모리 등록
- 자신의 메모리 영역을 시스템 메모리로 매핑하여 사용
- request_region, release_region 함수에 의해 등록/해제


### 장치와 커널 간 통신
#### 폴링
- 커널측에서 수행
- 장치의 상태를 주기적으로 체크하여 변경사항 확인
#### 인터럽트
- 장치 측에서 수행
- 장치가 커널의 주의를 끌기위해 하드웨어 신호 발생

### 하드웨어 인터럽트
- 모든 인터럽트는 인터럽트 핸들러 함수를 실행하는 형태로 동작
  - 장치별로 다른 핸들러를 지님
  - 디바이스 드라이버에 의해 설치
- NIC 등록 단계에서 IRQ를 할당받고 이에 대한 핸들러를 등록
  - 관련 함수들
    - kernel/irq/manage.c 에 정의
    #### int request_irq(unsigned int irq, irq_handler_t handler, unsigned long flags, const char *name, void *dev) (= request_threaded_irq)
    - 핸들러 등록
    - IRQ의 유효성 확인 후 타 장치에 할당되지 않았는지 확인 후 등록
    #### void free_irq(unsigned_int irq, void* dev_id)
    - 핸들러 제거
    - 다른 장치가 더 없다면 IRQ 라인 비활성
- 커널은 IRQ 번호를 사용해 드라이버 핸들러 탐색 및 수행
  - IRQ 번호와 핸들러 사이의 매핑을 전역 테이블에 저장
  - IRQ 번호:핸들러 = 1:N 관계
    - 여러개의 장치가 같은 IRQ 번호 사용 가능
    
 #### 인터럽트 종류
 ##### 프레임 수신
 - 가장 흔하고 표준적인 상황
 ##### 전송 실패
 - 이더넷 장치가 지연 전송까지 실패한 뒤에 발생
 - 상위 계층으로는 전달하지 않음
   - 상위 계층에서는 다른 방법으로 실패를 체크해야 함
     - 타이머 타임아웃, 음수 ACK 등
 ##### DMA 전송 성공적 완료
 - 보내야 할 프레임을 저장하는 버퍼 영역은 NIC의 전송단 메모리로 옮겨진 뒤 해제
 - 동기 전송 (DMA 미사용) 의 경우 프레임이 NIC로 옮겨지는 순간 인지
 - DMA 사용시 (비동기 전송) 명확한 인터럽트가 있어야 드라이버가 인지 가능
   - ex) DMA 사용시 - drivers/net/ethernet/3com/3c59x.c 에서 dev_kfree_skb 호출
   - ex) DMa 미사용시 - drivers/net/ethernet/3com/3c509.c
   
